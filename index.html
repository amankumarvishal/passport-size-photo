// ... existing code ...

<script>
    // Initialize variables
    let originalImage = null;
    let processedImage = null;
    let net = null;

    // Get DOM elements
    const photoInput = document.getElementById('photoInput');
    const removeBgBtn = document.getElementById('removeBgBtn');
    const cropBtn = document.getElementById('cropBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const printBtn = document.getElementById('printBtn');
    const originalCanvas = document.getElementById('originalCanvas');
    const processedCanvas = document.getElementById('processedCanvas');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const loadingText = document.getElementById('loadingText');
    const statusMessage = document.getElementById('statusMessage');
    const bgColor = document.getElementById('bgColor');
    const imageQuality = document.getElementById('imageQuality');

    // Canvas contexts
    const originalCtx = originalCanvas.getContext('2d');
    const processedCtx = processedCanvas.getContext('2d');

    // Load BodyPix model
    async function loadModel() {
        try {
            showLoading("Loading AI model...");
            // Wait for TensorFlow.js to be ready
            await tf.ready();
            // Load the BodyPix model
            net = await bodyPix.load({
                architecture: 'MobileNetV1',
                outputStride: 16,
                multiplier: 0.75,
                quantBytes: 2
            });
            hideLoading();
            updateStatus("AI model loaded successfully");
            console.log("Model loaded successfully");
        } catch (error) {
            console.error("Error loading model:", error);
            hideLoading();
            updateStatus("Error loading AI model. Please refresh the page.", true);
        }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
        console.log("Page loaded, initializing...");
        loadModel();
    });

    // File input change event
    photoInput.addEventListener('change', function(e) {
        if (e.target.files && e.target.files[0]) {
            const file = e.target.files[0];
            
            // Check file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                updateStatus("File too large. Please select an image under 5MB.", true);
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(event) {
                originalImage = new Image();
                originalImage.onload = function() {
                    // Display original image
                    displayImage(originalImage, originalCanvas, originalCtx);
                    
                    // Initialize processed canvas with same dimensions
                    processedCanvas.width = originalCanvas.width;
                    processedCanvas.height = originalCanvas.height;
                    processedCtx.drawImage(originalImage, 0, 0, processedCanvas.width, processedCanvas.height);
                    
                    // Store original in processed image
                    processedImage = new Image();
                    processedImage.src = processedCanvas.toDataURL('image/png');
                    
                    // Enable buttons
                    removeBgBtn.disabled = false;
                    cropBtn.disabled = false;
                    downloadBtn.disabled = false;
                    printBtn.disabled = false;
                    
                    updateStatus("Image loaded successfully. You can now process it.");
                };
                originalImage.src = event.target.result;
            };
            
            reader.readAsDataURL(file);
            updateStatus("Loading image...");
        }
    });

    // Remove background button click event
    removeBgBtn.addEventListener('click', async function() {
        if (!originalImage) {
            updateStatus("Please upload an image first", true);
            return;
        }
        
        if (!net) {
            updateStatus("AI model not loaded yet. Please wait...", true);
            return;
        }
        
        showLoading("Removing background...");
        
        try {
            // Create a temporary canvas for processing
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = originalImage.width;
            tempCanvas.height = originalImage.height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(originalImage, 0, 0);

            console.log("Starting segmentation...");
            // Perform segmentation
            const segmentation = await net.segmentPerson(tempCanvas, {
                flipHorizontal: false,
                internalResolution: 'medium',
                segmentationThreshold: 0.5,
                maxDetections: 1
            });
            console.log("Segmentation complete");

            // Create mask
            const mask = bodyPix.toMask(segmentation);
            
            // Clear the canvas
            tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);
            
            // Draw original image
            tempCtx.drawImage(originalImage, 0, 0);
            
            // Apply mask
            bodyPix.drawMask(
                tempCanvas,
                tempCanvas,
                mask,
                1, // opacity
                2, // maskBlurAmount
                false // flipHorizontal
            );

            // Display result
            processedImage = new Image();
            processedImage.onload = function() {
                displayImage(processedImage, processedCanvas, processedCtx);
                hideLoading();
                updateStatus("Background removed successfully");
            };
            processedImage.src = tempCanvas.toDataURL('image/png');
        } catch (error) {
            console.error("Error removing background:", error);
            hideLoading();
            updateStatus("Error removing background. Please try again.", true);
        }
    });

    // ... rest of existing code ...
</script>
