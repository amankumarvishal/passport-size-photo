// ... existing code ...

<script>
    // Initialize variables
    let originalImage = null;
    let processedImage = null;
    let net = null;

    // Get DOM elements
    const photoInput = document.getElementById('photoInput');
    const removeBgBtn = document.getElementById('removeBgBtn');
    const cropBtn = document.getElementById('cropBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const printBtn = document.getElementById('printBtn');
    const originalCanvas = document.getElementById('originalCanvas');
    const processedCanvas = document.getElementById('processedCanvas');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const loadingText = document.getElementById('loadingText');
    const statusMessage = document.getElementById('statusMessage');
    const bgColor = document.getElementById('bgColor');
    const imageQuality = document.getElementById('imageQuality');

    // Canvas contexts
    const originalCtx = originalCanvas.getContext('2d');
    const processedCtx = processedCanvas.getContext('2d');

    // Load BodyPix model
    async function loadModel() {
        try {
            showLoading("Loading AI model...");
            // Wait for TensorFlow.js to be ready
            await tf.ready();
            console.log("TensorFlow.js is ready");
            
            // Load the BodyPix model
            net = await bodyPix.load({
                architecture: 'MobileNetV1',
                outputStride: 16,
                multiplier: 0.75,
                quantBytes: 2
            });
            console.log("BodyPix model loaded");
            hideLoading();
            updateStatus("AI model loaded successfully");
        } catch (error) {
            console.error("Error loading model:", error);
            hideLoading();
            updateStatus("Error loading AI model. Please refresh the page.", true);
        }
    }

    // Initialize on page load
    window.addEventListener('load', () => {
        console.log("Window loaded, initializing...");
        loadModel();
    });

    // Display image on canvas
    function displayImage(image, canvas, ctx) {
        const maxWidth = 400;
        const maxHeight = 400;
        
        let width = image.width;
        let height = image.height;
        
        if (width > maxWidth) {
            height = (maxWidth / width) * height;
            width = maxWidth;
        }
        
        if (height > maxHeight) {
            width = (maxHeight / height) * width;
            height = maxHeight;
        }
        
        canvas.width = width;
        canvas.height = height;
        ctx.drawImage(image, 0, 0, width, height);
    }

    // Remove background button click event
    removeBgBtn.addEventListener('click', async function() {
        if (!originalImage) {
            updateStatus("Please upload an image first", true);
            return;
        }
        
        if (!net) {
            updateStatus("AI model not loaded yet. Please wait...", true);
            return;
        }
        
        showLoading("Removing background...");
        
        try {
            // Create a temporary canvas for processing
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = originalImage.width;
            tempCanvas.height = originalImage.height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(originalImage, 0, 0);

            console.log("Starting segmentation...");
            // Perform segmentation
            const segmentation = await net.segmentPerson(tempCanvas, {
                flipHorizontal: false,
                internalResolution: 'medium',
                segmentationThreshold: 0.5,
                maxDetections: 1
            });
            console.log("Segmentation complete");

            // Create mask
            const mask = bodyPix.toMask(segmentation);
            
            // Clear the canvas
            tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);
            
            // Draw original image
            tempCtx.drawImage(originalImage, 0, 0);
            
            // Apply mask
            bodyPix.drawMask(
                tempCanvas,
                tempCanvas,
                mask,
                1, // opacity
                2, // maskBlurAmount
                false // flipHorizontal
            );

            // Display result
            processedImage = new Image();
            processedImage.onload = function() {
                displayImage(processedImage, processedCanvas, processedCtx);
                hideLoading();
                updateStatus("Background removed successfully");
            };
            processedImage.src = tempCanvas.toDataURL('image/png');
        } catch (error) {
            console.error("Error removing background:", error);
            hideLoading();
            updateStatus("Error removing background. Please try again.", true);
        }
    });

    // Helper functions
    function showLoading(message = "Processing...") {
        loadingText.textContent = message;
        loadingIndicator.style.display = 'block';
        disableButtons(true);
    }

    function hideLoading() {
        loadingIndicator.style.display = 'none';
        disableButtons(false);
    }

    function disableButtons(disabled) {
        removeBgBtn.disabled = disabled;
        cropBtn.disabled = disabled;
        downloadBtn.disabled = disabled;
        printBtn.disabled = disabled;
    }

    function updateStatus(message, isError = false) {
        statusMessage.textContent = message;
        statusMessage.style.color = isError ? '#e74c3c' : '#7f8c8d';
    }

    // ... rest of existing code ...
</script>
